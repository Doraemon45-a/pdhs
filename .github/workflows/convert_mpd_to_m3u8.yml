name: Convert MPD to M3U8 with Shaka Packager

on:
  workflow_dispatch: # Memungkinkan workflow dijalankan manual

jobs:
  convert-mpd-to-m3u8:
    runs-on: ubuntu-latest

    steps:
    - name: Install Shaka Packager
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://github.com/shaka-project/shaka-packager/releases/download/v3.4.1/packager-linux-x64 \
          -O /usr/local/bin/packager
        chmod +x /usr/local/bin/packager


    - name: Convert MPD to M3U8
      env:
        MPD_URL: "https://fsly.stream.peacocktv.com/Content/CMAF_OL1-CTR-4s/Live/channel(knbc)/master.mpd"
        KEY_ID: "0045a118e231f1326bcdb45350b1ceaa"
        KEY: "8c13afbfa54ea37a368b8b859021f6e3"
        OUTPUT_FILE: "output.m3u8"
      run: |
        echo "Starting MPD to M3U8 conversion with Shaka Packager..."

        packager \
          input=$MPD_URL,stream=video,output=video.mp4,drm_label=VIDEO:key_id=$KEY_ID:key=$KEY \
          input=$MPD_URL,stream=audio,output=audio.mp4,drm_label=AUDIO:key_id=$KEY_ID:key=$KEY \
          --mpd_output $OUTPUT_FILE

        echo "Conversion completed: $OUTPUT_FILE"

    - name: Upload M3U8 to Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: converted-m3u8
        path: output.m3u8
